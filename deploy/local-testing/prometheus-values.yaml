# Prometheus Helm chart values for local testing
# Uses kube-prometheus-stack chart from prometheus-community
#
# Install with:
#   helm install prometheus prometheus-community/kube-prometheus-stack \
#     --namespace monitoring --create-namespace \
#     -f prometheus-values.yaml

# Prometheus configuration
prometheus:
  prometheusSpec:
    # Scrape interval
    scrapeInterval: 15s
    evaluationInterval: 15s

    # Resource limits for local testing
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    # Storage - minimal for local testing
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 5Gi

    # Enable scraping of all ServiceMonitors
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false

    # Additional scrape configs for cw-agent-certmanager
    additionalScrapeConfigs:
      - job_name: 'cw-agent-certmanager'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - certwatch
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: cw-agent-certmanager
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            action: keep
            regex: '9402'

  service:
    type: NodePort
    nodePort: 30090

# Grafana configuration
grafana:
  enabled: true

  # Admin credentials (change in production!)
  adminUser: admin
  adminPassword: certwatch123

  service:
    type: NodePort
    nodePort: 30030

  # Resource limits
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Pre-configured dashboards
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'certwatch'
          orgId: 1
          folder: 'CertWatch'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/certwatch

  # CertWatch dashboard - Improved with Phase 2 metrics
  dashboards:
    certwatch:
      certmanager-agent:
        json: |
          {
            "annotations": {
              "list": []
            },
            "editable": true,
            "fiscalYearStartMonth": 0,
            "graphTooltip": 1,
            "id": null,
            "links": [],
            "panels": [
              {
                "collapsed": false,
                "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
                "id": 100,
                "panels": [],
                "title": "Overview",
                "type": "row"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "thresholds" },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "blue", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 },
                "id": 1,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "center",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "value"
                },
                "targets": [
                  {
                    "expr": "certwatch_certmanager_certificates_watched",
                    "refId": "A"
                  }
                ],
                "title": "Total Certificates",
                "type": "stat"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "thresholds" },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 },
                "id": 2,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "center",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "value"
                },
                "targets": [
                  {
                    "expr": "count(certwatch_certmanager_certificate_ready == 1)",
                    "refId": "A"
                  }
                ],
                "title": "Ready",
                "type": "stat"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "thresholds" },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "yellow", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 4, "w": 4, "x": 8, "y": 1 },
                "id": 3,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "center",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "value"
                },
                "targets": [
                  {
                    "expr": "count(certwatch_certmanager_certificate_issuing == 1) or vector(0)",
                    "refId": "A"
                  }
                ],
                "title": "Issuing",
                "type": "stat"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "thresholds" },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null },
                        { "color": "red", "value": 1 }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 4, "w": 4, "x": 12, "y": 1 },
                "id": 4,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "center",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "value"
                },
                "targets": [
                  {
                    "expr": "count(certwatch_certmanager_certificate_ready == 0) or vector(0)",
                    "refId": "A"
                  }
                ],
                "title": "Not Ready",
                "type": "stat"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "thresholds" },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null },
                        { "color": "orange", "value": 1 },
                        { "color": "red", "value": 5 }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 4, "w": 4, "x": 16, "y": 1 },
                "id": 5,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "center",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "value"
                },
                "targets": [
                  {
                    "expr": "count(certwatch_certmanager_certificate_days_until_expiry <= 30) or vector(0)",
                    "refId": "A"
                  }
                ],
                "title": "Expiring Soon (30d)",
                "type": "stat"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "thresholds" },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "purple", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 4, "w": 4, "x": 20, "y": 1 },
                "id": 6,
                "options": {
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "center",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "value"
                },
                "targets": [
                  {
                    "expr": "certwatch_certmanager_agent_info",
                    "legendFormat": "v{{version}}",
                    "refId": "A"
                  }
                ],
                "title": "Agent Version",
                "type": "stat"
              },
              {
                "collapsed": false,
                "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
                "id": 101,
                "panels": [],
                "title": "Certificate Health",
                "type": "row"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "thresholds" },
                    "custom": {
                      "align": "auto",
                      "displayMode": "auto",
                      "inspect": false
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    }
                  },
                  "overrides": [
                    {
                      "matcher": { "id": "byName", "options": "Ready" },
                      "properties": [
                        {
                          "id": "custom.displayMode",
                          "value": "color-background"
                        },
                        {
                          "id": "mappings",
                          "value": [
                            { "options": { "0": { "color": "red", "index": 0, "text": "No" }, "1": { "color": "green", "index": 1, "text": "Yes" } }, "type": "value" }
                          ]
                        },
                        { "id": "custom.width", "value": 80 }
                      ]
                    },
                    {
                      "matcher": { "id": "byName", "options": "Days Until Expiry" },
                      "properties": [
                        {
                          "id": "custom.displayMode",
                          "value": "color-background-solid"
                        },
                        {
                          "id": "thresholds",
                          "value": {
                            "mode": "absolute",
                            "steps": [
                              { "color": "red", "value": null },
                              { "color": "orange", "value": 14 },
                              { "color": "yellow", "value": 30 },
                              { "color": "green", "value": 60 }
                            ]
                          }
                        },
                        { "id": "unit", "value": "d" },
                        { "id": "custom.width", "value": 120 }
                      ]
                    },
                    {
                      "matcher": { "id": "byName", "options": "Issuing" },
                      "properties": [
                        {
                          "id": "mappings",
                          "value": [
                            { "options": { "0": { "color": "transparent", "index": 0, "text": "-" }, "1": { "color": "yellow", "index": 1, "text": "Yes" } }, "type": "value" }
                          ]
                        },
                        { "id": "custom.width", "value": 70 }
                      ]
                    }
                  ]
                },
                "gridPos": { "h": 8, "w": 14, "x": 0, "y": 6 },
                "id": 7,
                "options": {
                  "footer": { "enablePagination": true, "fields": "", "reducer": ["sum"], "show": false },
                  "showHeader": true,
                  "sortBy": [{ "desc": false, "displayName": "Days Until Expiry" }]
                },
                "targets": [
                  {
                    "expr": "certwatch_certmanager_certificate_ready",
                    "format": "table",
                    "instant": true,
                    "refId": "A"
                  },
                  {
                    "expr": "certwatch_certmanager_certificate_days_until_expiry",
                    "format": "table",
                    "instant": true,
                    "refId": "B"
                  },
                  {
                    "expr": "certwatch_certmanager_certificate_issuing",
                    "format": "table",
                    "instant": true,
                    "refId": "C"
                  }
                ],
                "title": "Certificate Status Table",
                "transformations": [
                  { "id": "seriesToColumns", "options": { "byField": "name" } },
                  {
                    "id": "organize",
                    "options": {
                      "excludeByName": { "Time": true, "Time 1": true, "Time 2": true, "Time 3": true, "__name__": true, "__name__ 1": true, "__name__ 2": true, "__name__ 3": true, "instance": true, "instance 1": true, "instance 2": true, "instance 3": true, "job": true, "job 1": true, "job 2": true, "job 3": true, "issuer_kind 2": true, "issuer_kind 3": true, "issuer_name 2": true, "issuer_name 3": true, "namespace 2": true, "namespace 3": true },
                      "indexByName": {},
                      "renameByName": { "Value #A": "Ready", "Value #B": "Days Until Expiry", "Value #C": "Issuing", "issuer_kind": "Issuer Kind", "issuer_kind 1": "Issuer Kind", "issuer_name": "Issuer", "issuer_name 1": "Issuer", "name": "Certificate", "namespace": "Namespace", "namespace 1": "Namespace" }
                    }
                  }
                ],
                "type": "table"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "thresholds" },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "red", "value": null },
                        { "color": "orange", "value": 14 },
                        { "color": "yellow", "value": 30 },
                        { "color": "green", "value": 60 }
                      ]
                    },
                    "unit": "d"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 8, "w": 10, "x": 14, "y": 6 },
                "id": 8,
                "options": {
                  "displayMode": "gradient",
                  "minVizHeight": 10,
                  "minVizWidth": 0,
                  "orientation": "horizontal",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "showUnfilled": true,
                  "valueMode": "color"
                },
                "targets": [
                  {
                    "expr": "topk(10, certwatch_certmanager_certificate_days_until_expiry <= 90)",
                    "legendFormat": "{{namespace}}/{{name}}",
                    "refId": "A"
                  }
                ],
                "title": "Certificates Expiring Within 90 Days",
                "type": "bargauge"
              },
              {
                "collapsed": false,
                "gridPos": { "h": 1, "w": 24, "x": 0, "y": 14 },
                "id": 102,
                "panels": [],
                "title": "Expiry Timeline",
                "type": "row"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "Certificates expiring within 60 days (urgent)",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "Days",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 20,
                      "gradientMode": "opacity",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "smooth",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "auto",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "none" },
                      "thresholdsStyle": { "mode": "area" }
                    },
                    "mappings": [],
                    "max": 60,
                    "min": 0,
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "red", "value": null },
                        { "color": "orange", "value": 14 },
                        { "color": "yellow", "value": 30 },
                        { "color": "green", "value": 45 }
                      ]
                    },
                    "unit": "d"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 7, "w": 12, "x": 0, "y": 15 },
                "id": 9,
                "options": {
                  "legend": { "calcs": ["lastNotNull"], "displayMode": "table", "placement": "right", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "certwatch_certmanager_certificate_days_until_expiry <= 60",
                    "legendFormat": "{{namespace}}/{{name}}",
                    "refId": "A"
                  }
                ],
                "title": "Expiry Timeline - Urgent (â‰¤60 days)",
                "type": "timeseries"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "Certificates with more than 60 days until expiry",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "Days",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "gradientMode": "none",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "smooth",
                      "lineWidth": 1,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "none" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    },
                    "unit": "d"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 7, "w": 12, "x": 12, "y": 15 },
                "id": 10,
                "options": {
                  "legend": { "calcs": ["lastNotNull"], "displayMode": "table", "placement": "right", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "certwatch_certmanager_certificate_days_until_expiry > 60",
                    "legendFormat": "{{namespace}}/{{name}}",
                    "refId": "A"
                  }
                ],
                "title": "Expiry Timeline - Long Term (>60 days)",
                "type": "timeseries"
              },
              {
                "collapsed": false,
                "gridPos": { "h": 1, "w": 24, "x": 0, "y": 22 },
                "id": 103,
                "panels": [],
                "title": "Events & Failures (Phase 2)",
                "type": "row"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "cert-manager events grouped by reason",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "Events/sec",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "bars",
                      "fillOpacity": 80,
                      "gradientMode": "none",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "linear",
                      "lineWidth": 1,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "normal" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 7, "w": 12, "x": 0, "y": 23 },
                "id": 11,
                "options": {
                  "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "right", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "sum by (reason) (rate(certwatch_certmanager_event_total[5m]))",
                    "legendFormat": "{{reason}}",
                    "refId": "A"
                  }
                ],
                "title": "Event Rate by Reason",
                "type": "timeseries"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "Failure events categorized by root cause",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false }
                    },
                    "mappings": [],
                    "unit": "short"
                  },
                  "overrides": [
                    { "matcher": { "id": "byName", "options": "issuer" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "acme" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "validation" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "policy" }, "properties": [{ "id": "color", "value": { "fixedColor": "purple", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "unknown" }, "properties": [{ "id": "color", "value": { "fixedColor": "semi-dark-blue", "mode": "fixed" } }] }
                  ]
                },
                "gridPos": { "h": 7, "w": 6, "x": 12, "y": 23 },
                "id": 12,
                "options": {
                  "displayLabels": ["name", "percent"],
                  "legend": { "displayMode": "table", "placement": "right", "showLegend": true, "values": ["value"] },
                  "pieType": "pie",
                  "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false },
                  "tooltip": { "mode": "single", "sort": "none" }
                },
                "targets": [
                  {
                    "expr": "sum by (failure_category) (increase(certwatch_certmanager_event_total{failure_category!=\"\"}[1h]))",
                    "legendFormat": "{{failure_category}}",
                    "refId": "A"
                  }
                ],
                "title": "Failure Categories (1h)",
                "type": "piechart"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "Total failure events over time",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 30,
                      "gradientMode": "opacity",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "smooth",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "auto",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "none" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "red", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 7, "w": 6, "x": 18, "y": 23 },
                "id": 13,
                "options": {
                  "legend": { "calcs": ["sum"], "displayMode": "list", "placement": "bottom", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "sum by (failure_category) (rate(certwatch_certmanager_event_total{failure_category!=\"\"}[5m]))",
                    "legendFormat": "{{failure_category}}",
                    "refId": "A"
                  }
                ],
                "title": "Failure Rate by Category",
                "type": "timeseries"
              },
              {
                "collapsed": false,
                "gridPos": { "h": 1, "w": 24, "x": 0, "y": 30 },
                "id": 104,
                "panels": [],
                "title": "CertificateRequest Metrics (Phase 2)",
                "type": "row"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "CertificateRequest status distribution",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "bars",
                      "fillOpacity": 80,
                      "gradientMode": "none",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "linear",
                      "lineWidth": 1,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "normal" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": [
                    { "matcher": { "id": "byName", "options": "ready" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "approved" }, "properties": [{ "id": "color", "value": { "fixedColor": "blue", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "pending" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "denied" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "failed" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
                  ]
                },
                "gridPos": { "h": 6, "w": 12, "x": 0, "y": 31 },
                "id": 14,
                "options": {
                  "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "right", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "sum by (status) (rate(certwatch_certmanager_request_total[5m]))",
                    "legendFormat": "{{status}}",
                    "refId": "A"
                  }
                ],
                "title": "CertificateRequest Status Rate",
                "type": "timeseries"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "Time to issue certificates (p50, p90, p99)",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "Duration",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "gradientMode": "none",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "smooth",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "auto",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "none" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    },
                    "unit": "s"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 6, "w": 12, "x": 12, "y": 31 },
                "id": 15,
                "options": {
                  "legend": { "calcs": ["lastNotNull"], "displayMode": "table", "placement": "right", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "histogram_quantile(0.50, sum(rate(certwatch_certmanager_request_duration_seconds_bucket[5m])) by (le))",
                    "legendFormat": "p50",
                    "refId": "A"
                  },
                  {
                    "expr": "histogram_quantile(0.90, sum(rate(certwatch_certmanager_request_duration_seconds_bucket[5m])) by (le))",
                    "legendFormat": "p90",
                    "refId": "B"
                  },
                  {
                    "expr": "histogram_quantile(0.99, sum(rate(certwatch_certmanager_request_duration_seconds_bucket[5m])) by (le))",
                    "legendFormat": "p99",
                    "refId": "C"
                  }
                ],
                "title": "Certificate Issuance Duration",
                "type": "timeseries"
              },
              {
                "collapsed": false,
                "gridPos": { "h": 1, "w": 24, "x": 0, "y": 37 },
                "id": 105,
                "panels": [],
                "title": "Operational Metrics",
                "type": "row"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "Reconcile operations aggregated by controller",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "ops/sec",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 20,
                      "gradientMode": "none",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "smooth",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "none" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 6, "w": 8, "x": 0, "y": 38 },
                "id": 16,
                "options": {
                  "legend": { "calcs": ["mean"], "displayMode": "table", "placement": "bottom", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "sum by (controller) (rate(certwatch_certmanager_reconcile_total{result=\"success\"}[5m]))",
                    "legendFormat": "{{controller}}",
                    "refId": "A"
                  }
                ],
                "title": "Reconcile Rate (Success)",
                "type": "timeseries"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "Sync operations to CertWatch cloud",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 20,
                      "gradientMode": "none",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "smooth",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "none" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": [
                    { "matcher": { "id": "byName", "options": "success" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
                    { "matcher": { "id": "byName", "options": "error" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
                  ]
                },
                "gridPos": { "h": 6, "w": 8, "x": 8, "y": 38 },
                "id": 17,
                "options": {
                  "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "sum by (status) (rate(certwatch_certmanager_sync_total[5m]))",
                    "legendFormat": "{{status}}",
                    "refId": "A"
                  },
                  {
                    "expr": "sum by (status) (rate(certwatch_certmanager_event_sync_total[5m]))",
                    "legendFormat": "event-{{status}}",
                    "refId": "B"
                  },
                  {
                    "expr": "sum by (status) (rate(certwatch_certmanager_request_sync_total[5m]))",
                    "legendFormat": "request-{{status}}",
                    "refId": "C"
                  }
                ],
                "title": "Cloud Sync Rate",
                "type": "timeseries"
              },
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "description": "Reconcile duration percentiles",
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisColorMode": "text",
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "gradientMode": "none",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "smooth",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "none" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null }
                      ]
                    },
                    "unit": "s"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 6, "w": 8, "x": 16, "y": 38 },
                "id": 18,
                "options": {
                  "legend": { "calcs": ["lastNotNull"], "displayMode": "table", "placement": "bottom", "showLegend": true },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                },
                "targets": [
                  {
                    "expr": "histogram_quantile(0.50, sum(rate(certwatch_certmanager_reconcile_duration_seconds_bucket[5m])) by (le, controller))",
                    "legendFormat": "{{controller}} p50",
                    "refId": "A"
                  },
                  {
                    "expr": "histogram_quantile(0.99, sum(rate(certwatch_certmanager_reconcile_duration_seconds_bucket[5m])) by (le, controller))",
                    "legendFormat": "{{controller}} p99",
                    "refId": "B"
                  }
                ],
                "title": "Reconcile Duration",
                "type": "timeseries"
              }
            ],
            "refresh": "10s",
            "schemaVersion": 37,
            "style": "dark",
            "tags": ["certwatch", "cert-manager", "phase2"],
            "templating": { "list": [] },
            "time": { "from": "now-1h", "to": "now" },
            "timepicker": {},
            "timezone": "browser",
            "title": "CertWatch Agent - cert-manager",
            "uid": "certwatch-certmanager",
            "version": 2,
            "weekStart": ""
          }

# AlertManager configuration
alertmanager:
  enabled: true
  service:
    type: NodePort
    nodePort: 30903

  alertmanagerSpec:
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

# Node exporter - optional for local testing
nodeExporter:
  enabled: false

# Kube-state-metrics
kubeStateMetrics:
  enabled: true

# Prometheus operator
prometheusOperator:
  resources:
    limits:
      cpu: 200m
      memory: 200Mi
    requests:
      cpu: 100m
      memory: 100Mi
